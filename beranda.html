<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
  <title>PKD GP Ansor Kabupaten Bantul</title>

  <!-- Favicon & Font Modern -->
  <link rel="icon" type="image/png" href="LOGO ANSOR.webp">
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- Signature Pad & QR Generator (untuk halaman lain) -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  
  <style>
    /* ========== GAYA ASLI TETAP ========== */
    .navbar-brand {
      line-height: 1.2;
    }
    .brand-title {
      font-size: 1.35rem;
      font-weight: 700;
      color: #0a3d62;
    }
    .brand-sub {
      font-size: 0.9rem;
      font-weight: 400;
      color: #6c757d;
      display: block;
      margin-top: 2px;
      letter-spacing: 0.5px;
    }
    .navbar-brand img {
      height: 45px;
      width: auto;
      margin-right: 12px;
    }
    .nav-link.active {
      font-weight: 600;
      color: #0a3d62 !important;
    }
    .nav-link {
      color: #495057 !important;
      margin: 0 4px;
    }
    .nav-link:hover {
      color: #0a3d62 !important;
    }
    @media (max-width: 991px) {
      .navbar-brand img {
        height: 40px;
      }
      .brand-title {
        font-size: 1.2rem;
      }
    }
    * { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; }
    body {
      background: #f8fafc;
      color: #0f172a;
      line-height: 1.6;
    }
    .navbar {
      background: rgba(255,255,255,0.8) !important;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(203,213,225,0.3);
      box-shadow: 0 2px 6px rgba(0,0,0,0.02);
    }
    .navbar-brand {
      font-weight: 700;
      letter-spacing: -0.01em;
      color: #0f172a !important;
    }
    .navbar-brand img { 
      max-height: 40px; 
      width: auto; 
      transition: transform 0.2s;
    }
    .navbar-brand img:hover { transform: scale(1.02); }
    .nav-link {
      font-weight: 500;
      border-radius: 9999px;
      padding: 0.5rem 1.2rem;
      margin: 0 0.2rem;
      color: #334155 !important;
      transition: all 0.15s;
    }
    .nav-link:hover {
      background: rgba(37,99,235,0.06);
      color: #2563eb !important;
    }
    .nav-link.active {
      background: #2563eb !important;
      color: white !important;
      box-shadow: 0 4px 10px rgba(37,99,235,0.2);
    }
    .nav-link i { margin-right: 6px; }

    .container-card {
      max-width: 1000px;
      background: white;
      border-radius: 32px;
      padding: 2rem 2rem;
      margin: 30px auto;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
      border: 1px solid rgba(226,232,240,0.6);
      transition: box-shadow 0.2s;
    }
    .container-card:hover { box-shadow: 0 15px 30px -8px rgba(0,0,0,0.08); }
    .section-title {
      font-weight: 650;
      font-size: 1.75rem;
      margin-bottom: 1.8rem;
      color: #0f172a;
      border-left: 6px solid #2563eb;
      padding-left: 1.2rem;
      letter-spacing: -0.01em;
    }

    .feature-icon {
      font-size: 2.2rem;
      color: #2563eb;
      background: rgba(37,99,235,0.08);
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 30px;
      margin-bottom: 1rem;
    }

    .btn-rounded {
      border-radius: 9999px;
      padding: 0.6rem 2rem;
      font-weight: 600;
    }

    .footer-modern {
      font-size: 0.85rem;
      color: #64748b;
      margin-top: 3rem;
      text-align: center;
      padding: 1.5rem 0;
      border-top: 1px solid #e2e8f0;
      background: white;
    }

    /* ========== PERBAIKAN CHATBOT ========== */
    .chatbot-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #2563eb;
      color: white;
      border: none;
      box-shadow: 0 4px 20px rgba(37,99,235,0.3);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      z-index: 1032; /* lebih tinggi dari panel */
      transition: all 0.2s;
    }
    .chatbot-button:hover {
      transform: scale(1.1);
      background: #1d4ed8;
    }
    .chatbot-panel {
      position: fixed;
      bottom: 100px;
      right: 30px;
      width: 380px;
      max-width: calc(100vw - 60px);
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      z-index: 1031; /* di atas navbar (1030) */
      display: none;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #e2e8f0;
      max-height: 80vh; /* batasi agar tidak terlalu tinggi */
    }
    .chatbot-panel.show {
      display: flex;
    }
    .chatbot-header {
      background: #2563eb;
      color: white;
      padding: 16px 20px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .chatbot-header button {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    /* Rekomendasi pertanyaan */
    .chatbot-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px 16px;
      background: #f1f5f9;
      border-bottom: 1px solid #cbd5e1;
      flex-shrink: 0;
    }
    .suggestion-btn {
      background: white;
      border: 1px solid #94a3b8;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.85rem;
      color: #0f172a;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .suggestion-btn:hover {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    .chatbot-messages {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 16px;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px; /* batasi agar tidak memenuhi layar */
    }
    .chatbot-message {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 18px;
      word-wrap: break-word;
      font-size: 0.95rem;
      line-height: 1.4;
    }
    .chatbot-message.user {
      align-self: flex-end;
      background: #2563eb;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .chatbot-message.bot {
      align-self: flex-start;
      background: #e9eef5;
      color: #0f172a;
      border-bottom-left-radius: 4px;
    }
    .chatbot-input-area {
      flex-shrink: 0;
      display: flex;
      padding: 12px 16px;
      border-top: 1px solid #cbd5e1;
      background: white;
    }
    .chatbot-input-area input {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid #cbd5e1;
      border-radius: 999px;
      margin-right: 10px;
      font-size: 0.95rem;
    }
    .chatbot-input-area button {
      background: #2563eb;
      border: none;
      color: white;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .chatbot-input-area button:hover {
      background: #1d4ed8;
    }
    .chatbot-input-area button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<!-- ==================== NAVBAR MODERN ==================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top shadow-sm">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="beranda.html">
      <img src="LOGO ANSOR.webp" alt="GP Ansor" class="me-2">
      <span>
        <span class="brand-title">PKD GP Ansor</span>
        <span class="brand-sub">Kabupaten Bantul</span>
      </span>
    </a>
    <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain"
      aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarMain">
      <!-- Menu navigasi utama (bisa ditambahkan jika diperlukan) -->
      <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
        <!-- Kosong, karena navigasi menggunakan grid di beranda -->
      </ul>
      <!-- Tempat untuk status user (guest/admin/member) dan tombol login/logout -->
      <div class="d-flex align-items-center gap-2 ms-auto" id="navbarUserMenu"></div>
    </div>
  </div>
</nav>

<!-- ==================== MODAL LOGIN ==================== -->
<div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0 rounded-top-4">
        <h5 class="modal-title"><i class="bi bi-shield-lock me-2"></i>Login</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-3">
          <label class="form-label fw-semibold">Username</label>
          <input type="text" id="loginUsername" class="form-control rounded-3" placeholder="Masukkan username" autocomplete="off">
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">Password</label>
          <div class="input-group">
            <input type="password" id="loginPassword" class="form-control rounded-start-3" placeholder="Masukkan password" autocomplete="off">
            <button class="btn btn-outline-secondary rounded-end-3" type="button" onclick="togglePasswordVisibility('loginPassword')">
              <i class="bi bi-eye"></i>
            </button>
          </div>
        </div>
        <div id="loginError" class="text-danger mt-2 small" style="display: none;"></div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary rounded-pill px-4" id="loginSubmit">Login</button>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MODAL PREVIEW SKRINING (untuk halaman skrining) ==================== -->
<div class="modal fade" id="previewSkriningModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0 rounded-top-4">
        <h5 class="modal-title"><i class="bi bi-eye-fill me-2"></i>Preview Data Skrining</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4" id="previewSkriningBody"></div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal" id="previewEditBtn">‚úèÔ∏è Edit</button>
        <button type="button" class="btn btn-success rounded-pill px-4" id="previewKirimBtn">üì§ Kirim Skrining</button>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MODAL PREVIEW MATERI ==================== -->
<div class="modal fade" id="previewMateriModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="background: #1e1e2f; border-radius: 20px;">
      <div class="modal-header bg-dark text-white border-0 rounded-top-4">
        <h5 class="modal-title" id="previewMateriLabel">
          <i class="bi bi-file-earmark-play me-2"></i><span id="previewMateriJudul">Pratinjau Materi</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0 d-flex justify-content-center align-items-center" style="min-height: 70vh; background: #0f172a; border-radius: 0 0 20px 20px; position: relative;">
        <div id="previewMateriSpinner" class="position-absolute top-50 start-50 translate-middle">
          <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Memuat...</span>
          </div>
        </div>
        <iframe id="previewMateriIframe" src="" style="width: 100%; height: 80vh; border: none; border-radius: 0 0 20px 20px;" allowfullscreen onload="document.getElementById('previewMateriSpinner').style.display='none';"></iframe>
      </div>
      <div class="modal-footer border-0 bg-dark rounded-bottom-4">
        <button type="button" class="btn btn-outline-light rounded-pill px-4" data-bs-dismiss="modal">Tutup</button>
        <a id="previewMateriDownloadBtn" href="#" target="_blank" class="btn btn-primary rounded-pill px-4">
          <i class="bi bi-download me-1"></i>Unduh
        </a>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MODAL DETAIL ==================== -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0 rounded-top-4">
        <h5 class="modal-title" id="detailModalLabel">Detail</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4" id="detailModalBody"></div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MODAL TAMBAH/EDIT PESERTA (hanya admin, tapi modal tetap ada) ==================== -->
<div class="modal fade" id="pesertaModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0 rounded-top-4">
        <h5 class="modal-title" id="pesertaModalLabel">Tambah/Edit Peserta</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <input type="hidden" id="pesertaId">
        <div class="mb-3">
          <label class="form-label fw-bold">Foto</label>
          <input type="file" class="form-control" id="pesertaFoto" accept="image/*">
          <img id="pesertaFotoPreview" src="#" alt="Preview" style="max-width: 150px; display: none;" class="mt-2 rounded">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Nama Lengkap</label>
          <input type="text" class="form-control" id="pesertaNamaLengkap" required>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Tempat dan Tanggal Lahir</label>
          <input type="text" class="form-control" id="pesertaTempatTglLahir">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Pekerjaan</label>
          <input type="text" class="form-control" id="pesertaPekerjaan">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Pendidikan Terakhir</label>
          <input type="text" class="form-control" id="pesertaPendidikan">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Alamat</label>
          <textarea class="form-control" id="pesertaAlamat" rows="2"></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">No HP</label>
          <input type="tel" class="form-control" id="pesertaNoHP">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Email</label>
          <input type="email" class="form-control" id="pesertaEmail">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Utusan</label>
          <input type="text" class="form-control" id="pesertaUtusan">
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Pengalaman Organisasi</label>
          <textarea class="form-control" id="pesertaPengalaman" rows="3"></textarea>
        </div>
        <div id="pesertaModalError" class="text-danger small" style="display: none;"></div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary rounded-pill px-4" id="simpanPesertaBtn">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MODAL IMPOR CSV PESERTA ==================== -->
<div class="modal fade" id="importPesertaModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white border-0 rounded-top-4">
        <h5 class="modal-title"><i class="bi bi-file-earmark-arrow-up me-2"></i>Impor Data Peserta dari CSV</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <div class="mb-3">
          <label class="form-label fw-bold">Pilih File CSV</label>
          <input type="file" class="form-control" id="importCsvFile" accept=".csv" required>
          <div class="form-text text-muted">
            Format CSV harus memiliki header: 
            <code>nama_lengkap, tempat_tgl_lahir, pekerjaan, pendidikan_terakhir, alamat, no_hp, email, utusan, pengalaman_organisasi</code> 
            (kolom lain diabaikan).
          </div>
        </div>
        <div id="importCsvError" class="text-danger small" style="display: none;"></div>
        <div id="importCsvProgress" class="progress mt-2" style="display: none;">
          <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">Memproses...</div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary rounded-pill px-4" id="importCsvSubmitBtn">Upload</button>
      </div>
    </div>
  </div>
</div>

<!-- ==================== MODAL QR SESI (untuk admin) ==================== -->
<div class="modal fade" id="qrSesiModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-dark text-white border-0 rounded-top-4">
        <h5 class="modal-title"><i class="bi bi-qr-code-scan me-2"></i>QR Code Absen Sesi</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center p-4">
        <div id="qrSesiCanvasContainer"></div>
        <div id="qrSesiDataText" class="mt-3 small text-muted"></div>
        <div class="alert alert-info mt-3 mb-0 rounded-4 border-0 bg-light">
          <i class="bi bi-info-circle"></i> Scan QR ini untuk absen tanpa password.
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Tutup</button>
        <button type="button" class="btn btn-primary rounded-pill px-4" id="downloadQRSesiBtn">üíæ Download PNG</button>
      </div>
    </div>
  </div>
</div>

<!-- ==================== TOAST NOTIFICATION ==================== -->
<div class="toast-container">
  <div id="notificationToast" class="toast border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
    <div class="toast-header bg-white border-0">
      <i class="bi me-2" id="toastIcon"></i>
      <strong class="me-auto" id="toastTitle">Berhasil</strong>
      <small>baru saja</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastMessage"></div>
  </div>
</div>

<!-- ==================== KONTEN UTAMA ==================== -->
<div id="contentArea">
  <!-- BERANDA SECTION -->
  <section id="berandaSection" class="container container-card">
    <h2 class="section-title"><i class="bi bi-house-heart-fill me-2"></i>Selamat Datang di Sistem PKD</h2>
    <div class="row align-items-center">
      <div class="col-lg-6">
        <p style="font-size:1.2rem; line-height:1.7;">Portal digital <strong>Pelatihan Kepemimpinan Dasar (PKD) GP Ansor Kabupaten Bantul</strong>.</p>
        <p class="mb-4">Gunakan menu di bawah untuk mengakses fitur:</p>
        <!-- MENU GRID DENGAN IKON DI ATAS TEKS, SERAGAM DAN RAPI -->
        <div class="row g-4">
          <!-- Pre-test -->
          <div class="col-6 col-md-4 col-lg-6 col-xl-4">
            <div class="d-flex flex-column align-items-center justify-content-center text-center h-100 p-3 border rounded-4 shadow-sm" onclick="window.location.href='pretest.html'" style="cursor: pointer;" role="button">
              <div class="feature-icon mb-3"><i class="bi bi-pencil-square"></i></div>
              <div><strong>Pre-test</strong><br><span class="text-muted small">Uji pengetahuan awal sebelum pelatihan.</span></div>
            </div>
          </div>
          <!-- Post-test -->
          <div class="col-6 col-md-4 col-lg-6 col-xl-4">
            <div class="d-flex flex-column align-items-center justify-content-center text-center h-100 p-3 border rounded-4 shadow-sm" onclick="window.location.href='posttest.html'" style="cursor: pointer;" role="button">
              <div class="feature-icon mb-3"><i class="bi bi-trophy"></i></div>
              <div><strong>Post-test</strong><br><span class="text-muted small">Evaluasi setelah materi selesai.</span></div>
            </div>
          </div>
          <!-- Absen Digital -->
          <div class="col-6 col-md-4 col-lg-6 col-xl-4">
            <div class="d-flex flex-column align-items-center justify-content-center text-center h-100 p-3 border rounded-4 shadow-sm" onclick="window.location.href='absen.html'" style="cursor: pointer;" role="button">
              <div class="feature-icon mb-3"><i class="bi bi-qr-code"></i></div>
              <div><strong>Absen Digital</strong><br><span class="text-muted small">Scan QR atau masukkan password sesi.</span></div>
            </div>
          </div>
          <!-- Skrining -->
          <div class="col-6 col-md-4 col-lg-6 col-xl-4">
            <div class="d-flex flex-column align-items-center justify-content-center text-center h-100 p-3 border rounded-4 shadow-sm" onclick="window.location.href='skrining.html'" style="cursor: pointer;" role="button">
              <div class="feature-icon mb-3"><i class="bi bi-clipboard-check"></i></div>
              <div><strong>Skrining</strong><br><span class="text-muted small">Form pendataan awal peserta.</span></div>
            </div>
          </div>
          <!-- Peserta -->
          <div class="col-6 col-md-4 col-lg-6 col-xl-4">
            <div class="d-flex flex-column align-items-center justify-content-center text-center h-100 p-3 border rounded-4 shadow-sm" onclick="window.location.href='peserta.html'" style="cursor: pointer;" role="button">
              <div class="feature-icon mb-3"><i class="bi bi-person-badge"></i></div>
              <div><strong>Peserta</strong><br><span class="text-muted small">Isi data diri peserta PKD.</span></div>
            </div>
          </div>
          <!-- Materi -->
          <div class="col-6 col-md-4 col-lg-6 col-xl-4">
            <div class="d-flex flex-column align-items-center justify-content-center text-center h-100 p-3 border rounded-4 shadow-sm" onclick="window.location.href='materi.html'" style="cursor: pointer;" role="button">
              <div class="feature-icon mb-3"><i class="bi bi-file-earmark-pdf"></i></div>
              <div><strong>Materi</strong><br><span class="text-muted small">Akses materi pelatihan, tayangkan langsung.</span></div>
            </div>
          </div>
          <!-- Tentang Kami -->
          <div class="col-6 col-md-4 col-lg-6 col-xl-4">
            <div class="d-flex flex-column align-items-center justify-content-center text-center h-100 p-3 border rounded-4 shadow-sm" onclick="window.location.href='about.html'" style="cursor: pointer;" role="button">
              <div class="feature-icon mb-3"><i class="bi bi-info-circle"></i></div>
              <div><strong>Tentang Kami</strong><br><span class="text-muted small">Informasi seputar PKD GP Ansor Bantul.</span></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6 text-center">
        <img src="LOGO ANSOR.webp" alt="Logo Ansor" style="max-width:200px; opacity:0.9;" class="mt-4 mt-lg-0">
        <div class="mt-3 text-muted">"Berdaya, Berkhidmat, Berkemajuan"</div>
      </div>
    </div>
    <hr class="my-5">
    <!-- Baris tambahan (kosong) -->
  </section>
</div>

<!-- ==================== FOOTER ==================== -->
<footer class="footer-modern container">
  <div class="d-flex justify-content-center align-items-center gap-2">
    <i class="bi bi-c-circle"></i>
    <span>Hak Cipta 2026 - Tim Instruktur GP Ansor Kabupaten Bantul. Semua Hak Dilindungi</span>
  </div>
  <!-- BADGE TOTAL KADER REAL TIME (dengan ID container) -->
  <div class="mt-2" id="realtimeBadgeContainer">
    <span class="badge bg-primary">Total Kader Terdaftar: <span id="totalPeserta">-</span></span>
  </div>
</footer>

<!-- ==================== AI CHATBOT PUTER.JS ==================== -->
<script src="https://js.puter.com/v2/"></script>
<div>
  <button class="chatbot-button" id="chatbotToggleBtn" title="Tanya AI">
    <i class="bi bi-chat-dots-fill"></i>
  </button>
  <div class="chatbot-panel" id="chatbotPanel">
    <div class="chatbot-header">
      <span><i class="bi bi-robot me-2"></i>AI Assistant (Puter)</span>
      <button id="chatbotCloseBtn"><i class="bi bi-x-lg"></i></button>
    </div>
    <!-- ===== REKOMENDASI PERTANYAAN ===== -->
    <div class="chatbot-suggestions" id="chatbotSuggestions">
      <button class="suggestion-btn">üìÖ Kapan pretest?</button>
      <button class="suggestion-btn">üìù Cara daftar PKD?</button>
      <button class="suggestion-btn">üìö Materi apa saja?</button>
      <button class="suggestion-btn">üìû Kontak panitia</button>
      <button class="suggestion-btn">üìç Alamat sekretariat</button>
    </div>
    <div class="chatbot-messages" id="chatbotMessages">
      <div class="chatbot-message bot">Halo! Saya asisten AI. Tanyakan apa pun seputar PKD.</div>
    </div>
    <div class="chatbot-input-area">
      <input type="text" id="chatbotInput" placeholder="Ketik pesan...">
      <button id="chatbotSendBtn"><i class="bi bi-send-fill"></i></button>
    </div>
  </div>
</div>

<!-- ==================== BOOTSTRAP JS ==================== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ==================== SCRIPT UTAMA ==================== -->
<script>
  // =====================================================
  //   KONFIGURASI & STATE
  // =====================================================
  const scriptUrl = 'https://script.google.com/macros/s/AKfycbwzJdoG3eGJy70ZJvrAwG7mbaHZ69hUPDc9_kzBFMrc_bepO5dAVm927-vrJh9l4qLa/exec'; // GANTI DENGAN URL ANDA!

  let userRole = null;        // null, 'admin', 'member'
  let userData = {};          // { username, nama, email, nohp } untuk member, { username, nama } untuk admin

  // =====================================================
  //   FUNGSI BANTU
  // =====================================================
  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  window.togglePasswordVisibility = function(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
  };

  // =====================================================
  //   PANGGILAN APPS SCRIPT (dengan fallback JSONP)
  // =====================================================
  async function callAppsScript(params, method = 'GET', timeout = 30000) {
    return new Promise(async (resolve, reject) => {
      const queryString = new URLSearchParams(params).toString();
      if (method === 'GET') {
        try {
          const res = await fetch(`${scriptUrl}?${queryString}`, { method: 'GET', mode: 'cors' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          resolve(data);
        } catch (fetchError) {
          console.warn('Fetch GET gagal, fallback ke JSONP:', fetchError);
          const callbackName = 'jsonp_callback_' + Date.now();
          const script = document.createElement('script');
          let isResolved = false;
          let timer = setTimeout(() => {
            if (!isResolved) {
              isResolved = true;
              if (document.head.contains(script)) document.head.removeChild(script);
              delete window[callbackName];
              reject(new Error('‚è±Ô∏è Timeout: Server tidak merespon JSONP.'));
            }
          }, timeout);

          window[callbackName] = function(data) {
            if (!isResolved) {
              isResolved = true;
              clearTimeout(timer);
              resolve(data || {});
            }
            delete window[callbackName];
            if (document.head.contains(script)) document.head.removeChild(script);
          };

          script.onerror = (err) => {
            if (!isResolved) {
              isResolved = true;
              clearTimeout(timer);
              delete window[callbackName];
              if (document.head.contains(script)) document.head.removeChild(script);
              reject(new Error('‚ùå Gagal memuat script JSONP. Pastikan endpoint mendukung JSONP.'));
            }
          };

          const cleanParams = { ...params };
          delete cleanParams.tandaTangan;
          delete cleanParams.signature;

          const newQuery = new URLSearchParams({ ...cleanParams, callback: callbackName }).toString();
          script.src = `${scriptUrl}?${newQuery}`;
          document.head.appendChild(script);
        }
      } else {
        fetch(scriptUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(params)
        })
          .then(() => resolve({ success: true, message: 'Request sent (no-cors)' }))
          .catch(reject);
      }
    });
  }

  // =====================================================
  //   PERSISTENSI AUTH
  // =====================================================
  function persistAuthState() {
    const state = { role: userRole, data: userData };
    sessionStorage.setItem('pkd_auth', JSON.stringify(state));
    localStorage.setItem('pkd_auth', JSON.stringify(state));
  }

  function loadAuthState() {
    let serialized = sessionStorage.getItem('pkd_auth') || localStorage.getItem('pkd_auth');
    if (serialized) {
      try {
        const state = JSON.parse(serialized);
        userRole = state.role || null;
        userData = state.data || {};
      } catch (e) {
        console.warn('Gagal parse auth state', e);
      }
    }
    updateNavbarMenu();
  }

  // =====================================================
  //   UPDATE NAVBAR MENU
  // =====================================================
  function updateNavbarMenu() {
    const menu = document.getElementById('navbarUserMenu');
    if (!menu) return;
    if (userRole === 'admin') {
      menu.innerHTML = `
        <span class="badge bg-light text-dark px-3 py-2 rounded-pill me-2">
          <i class="bi bi-shield-fill me-1"></i>Admin
        </span>
        <div class="dropdown">
          <button class="btn btn-outline-primary rounded-pill px-4 dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-person-circle me-1"></i> ${escapeHtml(userData.nama || 'Admin')}
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
            <li><a class="dropdown-item" href="admin.html"><i class="bi bi-gear-wide me-2"></i>Panel Admin</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i>Logout</button></li>
          </ul>
        </div>
      `;
    } else if (userRole === 'member') {
      menu.innerHTML = `
        <span class="badge bg-light text-dark px-3 py-2 rounded-pill me-2">
          <i class="bi bi-person-fill me-1"></i>Member
        </span>
        <div class="dropdown">
          <button class="btn btn-outline-primary rounded-pill px-4 dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-person-circle me-1"></i> ${escapeHtml(userData.nama || 'Member')}
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
            <li><a class="dropdown-item" href="member.html"><i class="bi bi-person-badge me-2"></i>Profil Saya</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i>Logout</button></li>
          </ul>
        </div>
      `;
    } else {
      menu.innerHTML = `
        <span class="badge bg-light text-dark px-3 py-2 rounded-pill me-2">
          <i class="bi bi-person-circle me-1"></i>Guest
        </span>
        <button class="btn btn-outline-primary rounded-pill px-4" id="loginBtn">
          <i class="bi bi-shield-lock me-1"></i>Login
        </button>
      `;
      document.getElementById('loginBtn')?.addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('loginModal'));
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('loginError').style.display = 'none';
        modal.show();
      });
    }

    document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
      e.preventDefault();
      logout();
    });
  }

  // =====================================================
  //   LOGOUT
  // =====================================================
  function logout() {
    userRole = null;
    userData = {};
    sessionStorage.removeItem('pkd_auth');
    localStorage.removeItem('pkd_auth');
    updateNavbarMenu();
    window.location.href = 'beranda.html';
  }

  // =====================================================
  //   LOGIN HANDLER
  // =====================================================
  document.getElementById('loginSubmit').addEventListener('click', async function() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    const errorDiv = document.getElementById('loginError');

    if (!username || !password) {
      errorDiv.innerText = 'Username dan password harus diisi!';
      errorDiv.style.display = 'block';
      return;
    }

    // Coba admin
    try {
      const adminRes = await callAppsScript({ action: 'verifyAdmin', username, password }, 'GET');
      if (adminRes.success && adminRes.role) {
        userRole = 'admin';
        userData = { username, nama: username };
        persistAuthState();
        showToast('Login admin berhasil', 'success');
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        updateNavbarMenu();
        return;
      }
    } catch (e) {
      console.warn('Login admin error', e);
    }

    // Coba member
    try {
      const memberRes = await callAppsScript({ action: 'verifyMember', username, password }, 'GET');
      if (memberRes.success && memberRes.role === 'member') {
        userRole = 'member';
        userData = {
          username: memberRes.username,
          nama: memberRes.nama,
          email: memberRes.email,
          nohp: memberRes.nohp
        };
        persistAuthState();
        showToast('Login member berhasil', 'success');
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        updateNavbarMenu();
        return;
      }
    } catch (e) {
      console.warn('Login member error', e);
    }

    errorDiv.innerText = 'Username atau password salah!';
    errorDiv.style.display = 'block';
  });

  // =====================================================
  //   TOAST
  // =====================================================
  function showToast(message, type = 'success') {
    const toastEl = document.getElementById('notificationToast');
    const toastMessage = document.getElementById('toastMessage');
    const toastIcon = document.getElementById('toastIcon');
    const toastTitle = document.getElementById('toastTitle');

    toastMessage.innerText = message;

    if (type === 'success') {
      toastEl.classList.add('border-success');
      toastEl.classList.remove('border-danger');
      toastIcon.className = 'bi bi-check-circle-fill me-2 text-success';
      toastTitle.innerText = 'Berhasil';
      toastTitle.style.color = '#28a745';
    } else {
      toastEl.classList.add('border-danger');
      toastEl.classList.remove('border-success');
      toastIcon.className = 'bi bi-x-circle-fill me-2 text-danger';
      toastTitle.innerText = 'Gagal';
      toastTitle.style.color = '#dc3545';
    }

    const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
    toast.show();
  }

  // =====================================================
  //   FUNGSI UPDATE TOTAL PESERTA (REAL TIME) DENGAN CEK PENGATURAN
  // =====================================================
  async function updateTotalPeserta() {
    const el = document.getElementById('totalPeserta');
    const container = document.getElementById('realtimeBadgeContainer');
    if (!el || !container) {
      console.warn('Elemen totalPeserta atau container tidak ditemukan');
      return;
    }
    try {
      // Cek pengaturan realtime
      const settingRes = await callAppsScript({ action: 'getRealtimeSetting' }, 'GET');
      if (settingRes.success && settingRes.enabled === false) {
        container.style.display = 'none';
        return;
      } else {
        container.style.display = 'block';
      }
      const res = await callAppsScript({ action: 'getTotalPeserta' }, 'GET');
      console.log('Res getTotalPeserta:', res); // tambahkan log
      if (res && res.success && typeof res.total === 'number') {
        el.innerText = res.total;
      } else {
        el.innerText = '?';
        console.error('Gagal mendapatkan total peserta:', res);
      }
    } catch (e) {
      console.error('Error updateTotalPeserta:', e);
      el.innerText = '?';
      container.style.display = 'block'; // tetap tampilkan jika error
    }
  }

  // =====================================================
  //   CHATBOT PUTER
  // =====================================================
  (function() {
    const toggleBtn = document.getElementById('chatbotToggleBtn');
    const panel = document.getElementById('chatbotPanel');
    const closeBtn = document.getElementById('chatbotCloseBtn');
    const messagesDiv = document.getElementById('chatbotMessages');
    const inputField = document.getElementById('chatbotInput');
    const sendBtn = document.getElementById('chatbotSendBtn');

    function addUserMessage(text) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'chatbot-message user';
      msgDiv.innerText = text;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addBotMessage(text) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'chatbot-message bot';
      msgDiv.innerText = text;
      messagesDiv.appendChild(msgDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Fungsi utama mengirim pesan ke AI
    async function sendMessageToPuter(message) {
      sendBtn.disabled = true;
      inputField.disabled = true;

      const systemPrompt = `Anda adalah asisten AI resmi untuk PKD GP Ansor Kabupaten Bantul. Tugas Anda membantu peserta, calon peserta, dan pengunjung website.

**Topik yang boleh dijawab:**
- Informasi umum tentang PKD GP Ansor Bantul (jadwal, pendaftaran, materi, persyaratan)
- Organisasi GP Ansor dan sejarahnya
- Teknis penggunaan website (form skrining, absen, pretest/posttest, materi)
- Kontak panitia, sekretariat, dan narahubung
- Informasi seputar kegiatan PKD

**Topik di luar itu**: tolak dengan sopan dan arahkan ke topik PKD.

**Gaya bicara**: Gunakan bahasa Indonesia formal namun ramah. Panggil pengguna dengan "Anda". Berikan jawaban yang membantu, tidak menghakimi.

**Informasi penting yang harus Anda ingat:**
- Sekretariat: Jl. Imogiri Timur KM 10, Bantul
- Kontak: 0812-3456-7890 (Bpk. Ahmad)
- Website: pkd.ansorbantul.or.id (placeholder)
- Pendaftaran PKD gelombang terakhir: 30 Maret 2026
- Materi tersedia di menu "Materi" (PDF/PPT)

**Contoh interaksi:**
- Peserta: "Kapan pretest dilaksanakan?"
- Asisten: "Pretest dilaksanakan secara online mulai 1 April 2026. Anda bisa mengaksesnya di menu 'Pre‚Äëtest' setelah login."

Jika ada pertanyaan yang tidak bisa dijawab, katakan: "Maaf, saya belum memiliki informasi tersebut. Silakan hubungi panitia melalui kontak yang tersedia."`;

      try {
        if (typeof puter === 'undefined' || !puter.ai) {
          throw new Error('Puter AI tidak tersedia. Pastikan Anda sudah login ke Puter.');
        }
        const response = await puter.ai.chat(message, {
          model: 'gpt-3.5-turbo',
          system: systemPrompt
        });
        addBotMessage(response);
      } catch (error) {
        addBotMessage(`‚ùå Error: ${error.message}. Periksa koneksi dan pastikan Anda sudah login ke Puter.`);
      } finally {
        sendBtn.disabled = false;
        inputField.disabled = false;
        inputField.focus();
      }
    }

    // Fungsi kirim pesan (dari input atau tombol saran)
    async function sendMessage(text) {
      if (!text) return;
      addUserMessage(text);
      inputField.value = ''; // kosongkan input
      await sendMessageToPuter(text);
    }

    // Event listener untuk tombol kirim
    sendBtn.addEventListener('click', () => sendMessage(inputField.value.trim()));
    inputField.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage(inputField.value.trim());
    });

    // Event listener untuk tombol saran pertanyaan
    document.querySelectorAll('.suggestion-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Ambil teks tanpa emoji (hapus karakter emoji di awal)
        let question = btn.innerText.replace(/^[üìÖüìùüìöüìûüìç]\s*/, ''); 
        sendMessage(question);
      });
    });

    toggleBtn.addEventListener('click', function() {
      panel.classList.toggle('show');
      if (panel.classList.contains('show')) inputField.focus();
    });
    closeBtn.addEventListener('click', function() {
      panel.classList.remove('show');
    });

    document.addEventListener('click', function(e) {
      if (!panel.contains(e.target) && !toggleBtn.contains(e.target) && panel.classList.contains('show')) {
        panel.classList.remove('show');
      }
    });
  })();

  // =====================================================
  //   INISIALISASI
  // =====================================================
  window.onload = function() {
    loadAuthState();
    updateTotalPeserta(); // Panggil pertama kali
    setInterval(updateTotalPeserta, 30000); // Update setiap 30 detik
  };
</script>
</body>
</html>