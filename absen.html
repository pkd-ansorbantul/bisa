<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
  <title>PKD GP Ansor Bantul ¬∑ Absen Digital</title>
  <link rel="icon" type="image/png" href="LOGO ANSOR.webp">
  <!-- Font & Bootstrap -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- Signature Pad -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <style>
    * { font-family: 'Inter', system-ui, sans-serif; }
    body {
      background: #f8fafc;
      color: #0f172a;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .navbar-brand {
      font-weight: 700;
      color: #0f172a !important;
    }
    .navbar-brand img {
      max-height: 40px;
      width: auto;
      margin-right: 12px;
    }
    .container-card {
      max-width: 700px;
      background: white;
      border-radius: 32px;
      padding: 2rem;
      margin: 30px auto;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05);
      border: 1px solid rgba(226,232,240,0.6);
    }
    .section-title {
      font-weight: 650;
      font-size: 1.75rem;
      margin-bottom: 1.8rem;
      color: #0f172a;
      border-left: 6px solid #2563eb;
      padding-left: 1.2rem;
    }
    .signature-area {
      border: 2px dashed #cbd5e1;
      border-radius: 20px;
      background: white;
      padding: 12px;
      transition: border-color 0.2s;
    }
    .signature-area:hover { border-color: #2563eb; }
    canvas {
      width: 100%;
      height: auto;
      max-width: 300px;
      max-height: 150px;
      background: white;
      display: block;
      border-radius: 12px;
      margin: 0 auto;
    }
    .signature-buttons {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      justify-content: center;
    }
    .btn-signature {
      border-radius: 9999px;
      padding: 0.4rem 1.6rem;
      font-size: 0.9rem;
    }
    .footer-modern {
      font-size: 0.85rem;
      color: #64748b;
      margin-top: auto;
      text-align: center;
      padding: 1.5rem 0;
      border-top: 1px solid #e2e8f0;
      background: white;
    }
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    .toast {
      background: white;
      border-left: 5px solid;
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
      border-radius: 16px;
    }
    .toast.border-success { border-left-color: #28a745; }
    .toast.border-danger { border-left-color: #dc3545; }
    @media (max-width: 576px) {
      .container-card { padding: 1.5rem; }
    }
  </style>
</head>
<body>

<!-- Navbar sederhana -->
<nav class="navbar navbar-expand-lg bg-white sticky-top shadow-sm">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="index.html">
      <img src="LOGO ANSOR.webp" alt="GP Ansor">
      <span>
        <span class="fw-bold">PKD GP Ansor</span><br>
        <small class="text-muted">Kabupaten Bantul ¬∑ Absen Digital</small>
      </span>
    </a>
    <a href="index.html" class="btn btn-outline-primary rounded-pill px-4 ms-auto">
      <i class="bi bi-arrow-left"></i> Kembali
    </a>
  </div>
</nav>

<!-- Konten utama -->
<div class="container container-card">
  <h2 class="section-title"><i class="bi bi-pen me-2"></i>Absen Digital per Sesi</h2>
  <div id="absenContainer">Memuat sesi...</div>
</div>

<!-- Footer -->
<footer class="footer-modern container">
  <i class="bi bi-c-circle"></i> 2026 ¬∑ Tim Instruktur GP Ansor Kabupaten Bantul
</footer>

<!-- Toast notifikasi -->
<div class="toast-container">
  <div id="notificationToast" class="toast border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
    <div class="toast-header bg-white border-0">
      <i class="bi me-2" id="toastIcon"></i>
      <strong class="me-auto" id="toastTitle">Berhasil</strong>
      <small>baru saja</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastMessage"></div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // =====================================================
  //   KONFIGURASI & STATE (khusus absen)
  // =====================================================
  const scriptUrl = 'https://script.google.com/macros/s/AKfycbwzJdoG3eGJy70ZJvrAwG7mbaHZ69hUPDc9_kzBFMrc_bepO5dAVm927-vrJh9l4qLa/exec'; // Ganti jika berbeda

  // Cache sesi sederhana
  let cachedSesi = null;

  // =====================================================
  //   FUNGSI BANTU
  // =====================================================
  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function showToast(message, type = 'success') {
    const toastEl = document.getElementById('notificationToast');
    const toastMessage = document.getElementById('toastMessage');
    const toastIcon = document.getElementById('toastIcon');
    const toastTitle = document.getElementById('toastTitle');

    toastMessage.innerText = message;

    if (type === 'success') {
      toastEl.classList.add('border-success');
      toastEl.classList.remove('border-danger');
      toastIcon.className = 'bi bi-check-circle-fill me-2 text-success';
      toastTitle.innerText = 'Berhasil';
      toastTitle.style.color = '#28a745';
    } else {
      toastEl.classList.add('border-danger');
      toastEl.classList.remove('border-success');
      toastIcon.className = 'bi bi-x-circle-fill me-2 text-danger';
      toastTitle.innerText = 'Gagal';
      toastTitle.style.color = '#dc3545';
    }

    const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
    toast.show();
  }

  // =====================================================
  //   PANGGILAN APPS SCRIPT (GET & POST)
  // =====================================================
  function callAppsScript(params, method = 'POST', timeout = 30000) {
    return new Promise(async (resolve, reject) => {
      if (method === 'GET') {
        try {
          const queryString = new URLSearchParams(params).toString();
          const response = await fetch(`${scriptUrl}?${queryString}`, {
            method: 'GET',
            mode: 'cors',
            headers: { 'Accept': 'application/json' }
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          return resolve(data);
        } catch (fetchError) {
          console.warn('Fetch GET gagal, fallback ke JSONP:', fetchError);
          // Fallback JSONP
          const callbackName = 'jsonp_callback_' + Date.now();
          const script = document.createElement('script');
          let isResolved = false;
          let timer = setTimeout(() => {
            if (!isResolved) {
              isResolved = true;
              if (document.head.contains(script)) document.head.removeChild(script);
              delete window[callbackName];
              reject(new Error('‚è±Ô∏è Timeout: Server tidak merespon.'));
            }
          }, timeout);

          window[callbackName] = function(data) {
            if (!isResolved) {
              isResolved = true;
              clearTimeout(timer);
              resolve(data || {});
            }
            delete window[callbackName];
            if (document.head.contains(script)) document.head.removeChild(script);
          };

          script.onerror = () => {
            if (!isResolved) {
              isResolved = true;
              clearTimeout(timer);
              delete window[callbackName];
              if (document.head.contains(script)) document.head.removeChild(script);
              reject(new Error('‚ùå Gagal memuat script JSONP.'));
            }
          };

          const cleanParams = { ...params };
          delete cleanParams.tandaTangan;
          delete cleanParams.signature;
          const queryString = new URLSearchParams({ ...cleanParams, callback: callbackName }).toString();
          script.src = `${scriptUrl}?${queryString}`;
          document.head.appendChild(script);
        }
      } else {
        // POST
        fetch(scriptUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(params)
        })
          .then(() => resolve({ success: true, message: 'Request sent (no-cors)' }))
          .catch(reject);
      }
    });
  }

  // =====================================================
  //   FETCH SESI ABSEN
  // =====================================================
  async function fetchSesiAbsen(forceRefresh = false) {
    if (!forceRefresh && cachedSesi) return cachedSesi;
    const res = await callAppsScript({ action: 'getSesiAbsen' }, 'GET');
    cachedSesi = res.data || [];
    return cachedSesi;
  }

  // =====================================================
  //   PENGELOLAAN STATE LOCALSTORAGE
  // =====================================================
  function saveAbsenFormState() {
    const nama = document.getElementById('namaAbsen')?.value || '';
    const sesiId = document.getElementById('pilihSesiAbsen')?.value || '';
    let signatureData = null;
    if (window.sigPadAbsen && !window.sigPadAbsen.isEmpty()) {
      signatureData = window.sigPadAbsen.toData();
    }
    localStorage.setItem('absenFormState', JSON.stringify({ nama, sesiId, signatureData }));
  }

  function restoreAbsenFormState() {
    const saved = localStorage.getItem('absenFormState');
    if (!saved) return;
    try {
      const { nama, sesiId, signatureData } = JSON.parse(saved);
      if (nama) document.getElementById('namaAbsen').value = nama;
      if (sesiId) document.getElementById('pilihSesiAbsen').value = sesiId;
      if (signatureData && window.sigPadAbsen) {
        window.sigPadAbsen.fromData(signatureData);
      }
    } catch (e) {}
  }

  function clearAbsenFormState() {
    localStorage.removeItem('absenFormState');
  }

  // =====================================================
  //   INISIALISASI SIGNATURE PAD
  // =====================================================
  function initAbsenSignaturePad() {
    const canvas = document.getElementById('signatureCanvasAbsen');
    if (!canvas) return;
    window.sigPadAbsen = new SignaturePad(canvas, { backgroundColor: 'white', penColor: 'black' });
    window.sigPadAbsen.clear();
    document.getElementById('clearAbsenSign')?.addEventListener('click', () => { window.sigPadAbsen.clear(); saveAbsenFormState(); });
    document.getElementById('undoAbsenSign')?.addEventListener('click', () => {
      const data = window.sigPadAbsen.toData();
      if (data) { data.pop(); window.sigPadAbsen.fromData(data); saveAbsenFormState(); }
    });
  }

  // =====================================================
  //   RENDER FORM ABSEN
  // =====================================================
  async function loadAbsenSesi() {
    const container = document.getElementById('absenContainer');
    container.innerHTML = 'Memuat sesi...';

    // Cek parameter URL
    const urlParams = new URLSearchParams(window.location.search);
    const sesiIdFromUrl = urlParams.get('sesi_id');
    const tokenFromUrl = urlParams.get('token');
    const isQRMode = !!(sesiIdFromUrl && tokenFromUrl);

    // Jika mode QR, hapus semua state tersimpan agar form selalu bersih
    if (isQRMode) {
      clearAbsenFormState();
    }

    // Ambil daftar sesi (paksa refresh jika mode QR)
    let sesiList;
    if (isQRMode) {
      sesiList = await fetchSesiAbsen(true);
    } else {
      sesiList = await fetchSesiAbsen(false);
    }

    if (!sesiList.length) {
      container.innerHTML = '<div class="alert alert-info">Belum ada sesi absen aktif.</div>';
      return;
    }

    // Validasi: jika mode QR dan sesiId tidak ditemukan dalam list
    if (isQRMode) {
      const foundSesi = sesiList.find(s => s.id == sesiIdFromUrl);
      if (!foundSesi) {
        container.innerHTML = `<div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle"></i> Sesi dengan ID ${sesiIdFromUrl} tidak ditemukan. Mungkin sesi telah dihapus atau token tidak valid.
        </div>`;
        return;
      }
    }

    let html = `<div class="mb-4 ${isQRMode ? 'qr-mode' : ''}">`;

    html += `<h5>Pilih Sesi</h5><select class="form-select" id="pilihSesiAbsen" ${isQRMode ? 'disabled' : ''}>`;
    sesiList.forEach(s => {
      const selected = (sesiIdFromUrl && s.id == sesiIdFromUrl) ? 'selected' : '';
      html += `<option value="${s.id}" ${selected}>${s.nama} (${s.waktu || ''})</option>`;
    });
    html += `</select></div>`;

    html += `<div class="mb-3">
                <label class="form-label fw-bold">Nama Lengkap</label>
                <input type="text" class="form-control" id="namaAbsen" required>
              </div>`;

    if (isQRMode) {
      html += `<input type="hidden" id="qrTokenAbsen" value="${escapeHtml(tokenFromUrl)}">`;
      html += `<div class="alert alert-success mb-3">
                <i class="bi bi-check-circle"></i> Absen via QR ‚Äì token terisi otomatis.
              </div>`;
    } else {
      html += `<div class="mb-3 password-field-wrapper">
                <label class="form-label fw-bold">üîë Password Sesi</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="passwordAbsen" placeholder="Masukkan password sesi">
                  <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('passwordAbsen')">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>`;
    }

    html += `<div class="mb-3">
                <label class="form-label fw-bold">‚úçÔ∏è Tanda Tangan Digital</label>
                <div class="signature-area"><canvas id="signatureCanvasAbsen" width="250" height="120"></canvas></div>
                <div class="signature-buttons">
                  <button type="button" class="btn btn-outline-secondary" id="clearAbsenSign">Hapus</button>
                  <button type="button" class="btn btn-outline-primary" id="undoAbsenSign">Undo</button>
                </div>
              </div>
              <button id="submitAbsenBtn" class="btn btn-warning btn-lg w-100 rounded-pill">üìã Kirim Absen</button>`;

    container.innerHTML = html;
    initAbsenSignaturePad();

    if (isQRMode) {
      const dropdown = document.getElementById('pilihSesiAbsen');
      if (dropdown) dropdown.value = sesiIdFromUrl;
      // Tidak restore karena sudah clear
    } else {
      restoreAbsenFormState();
    }

    // Event listeners untuk menyimpan state
    document.getElementById('namaAbsen')?.addEventListener('input', saveAbsenFormState);
    document.getElementById('pilihSesiAbsen')?.addEventListener('change', saveAbsenFormState);
    if (window.sigPadAbsen) {
      window.sigPadAbsen.addEventListener('endStroke', saveAbsenFormState);
    }

    // Submit handler
    document.getElementById('submitAbsenBtn').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Mengirim...';

      if (!window.sigPadAbsen || window.sigPadAbsen.isEmpty()) {
        showToast('Tanda tangan wajib!', 'danger');
        btn.disabled = false;
        btn.innerHTML = 'üìã Kirim Absen';
        return;
      }
      const nama = document.getElementById('namaAbsen').value.trim();
      if (!nama) {
        showToast('Nama wajib diisi!', 'danger');
        btn.disabled = false;
        btn.innerHTML = 'üìã Kirim Absen';
        return;
      }
      const sesiId = document.getElementById('pilihSesiAbsen').value;

      let params = {
        action: 'submitAbsen',
        nama: nama,
        sesiId: sesiId,
        tandaTangan: window.sigPadAbsen.toDataURL('image/jpeg', 0.2)
      };

      if (isQRMode) {
        params.qrToken = document.getElementById('qrTokenAbsen').value;
      } else {
        const password = document.getElementById('passwordAbsen').value.trim();
        if (!password) {
          showToast('Password sesi wajib diisi!', 'danger');
          btn.disabled = false;
          btn.innerHTML = 'üìã Kirim Absen';
          return;
        }
        params.password = password;
      }

      try {
        await callAppsScript(params, 'POST');
        showToast('‚úÖ Absen berhasil tercatat!', 'success');
        window.sigPadAbsen.clear();
        document.getElementById('namaAbsen').value = '';
        if (!isQRMode) document.getElementById('passwordAbsen').value = '';
        clearAbsenFormState();

        // Hapus parameter URL jika mode QR
        if (isQRMode) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      } catch (e) {
        showToast('‚ùå Error: ' + e.message, 'danger');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üìã Kirim Absen';
      }
    });
  }

  // =====================================================
  //   FUNGSI TOGGLE PASSWORD
  // =====================================================
  window.togglePasswordVisibility = function(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
  };

  // =====================================================
  //   INISIALISASI SAAT HALAMAN DIMUAT
  // =====================================================
  window.onload = function() {
    loadAbsenSesi();
  };
</script>
</body>
</html>